{% extends "registry/submission_step.html" %}
{% load i18n %}
{% block body %}

    <script type="text/javascript" src="/static/js/submission.utils.js"></script>
    <script type="text/javascript">
        $(document).ready(function() {
            
            $("select[multiple]").asmSelect({
                    addItemTarget: 'bottom',
                    animate: true,
                    highlight: true,
                    sortable: true
            });

            function make_decs_for(node){
                var set = node.id.match(/[a-z]-\d+/)[0]; // get django formset prefix
                return {'select':set+"-combodecs",
                        'div':set+'-decstools',
                        'input':set+'-searchfield',
                        'button':set+'-searchbutton',
                        'id':function(e){
                            return 'id_'+ this[e];
                        },
                        'create':function(e){
                            return $('<'+e+'>').attr('id',this.id(e)).attr('name',this[e]);
                        },
                        'set':set
                    };
            }

            function make_decstool_callback(decs){
                return function(data){
                    for(var i=0; i<data.length;i++){
                        $("<option>").attr("value",data[i].fields.label)
                            .html(data[i].fields.description)
                            .appendTo('#'+decs.id('select'));
                    }
                    $('#'+decs.id('select')).change(function(evt){
                        decs = make_decs_for(evt.target);
                        $("input#id_"+decs.set+"-code")
                            .attr("value",this.value);
                        $("input#id_"+decs.set+"-text")
                            .attr("value",$(this).find("option[selected]").html());
                    });
                    document.body.style.cursor="auto";
                }
            }

            var getterm_event = function(decsclient_url) {
                return function(){
                    this.parentNode.className = "";
                    if(this.value === 'DeCS'){
                        this.parentNode.className = "showdecs";
                        var decs = make_decs_for(this);

                        if($('#'+decs.id('select')).length === 0){
                            document.body.style.cursor="progress";
                            decs.create('div')
                                .appendTo(this.parentNode)
                                .append(decs.create('select'));

                            // TODO: Replace absolute path
                            $.get(decsclient_url,'',
                                make_decstool_callback(decs),"json");
                        }
                    }
                }
            };

            var search_event = function(decsclient_url) {
                return function(){
                    this.parentNode.className = "";
                    if(this.value === 'DeCS'){
                        this.parentNode.className = "showdecs";
                        var decs = make_decs_for(this);

                        if($('#'+decs.id('input')).length === 0){

                            decs.create('div')
                               .appendTo(this.parentNode)
                               .append(decs.create('input'))
                               .append(decs.create('button').html('{% trans "Search terms" %}'));

                            $('#'+decs.id('button'))
                                .click(function(evt){
                                    document.body.style.cursor="progress";
                                    var decs = make_decs_for(evt.target);
                                    if($('#'+decs.id('select')).length === 0){
                                        decs.create('select')
                                            .insertAfter(this);
                                    }
                                    $('#'+decs.id('select')).html('');

                                    $.get(decsclient_url+$('#'+decs.id('input')).val(),'',
                                        make_decstool_callback(decs),
                                        'json');
                                    return false;
                                });
                        }
                    }
                }
            };

            $("div.g select")
                .each(getterm_event("/decs/getterm/en/"))
                .change(getterm_event("/decs/getterm/en/"));

            $("div.s select")
                .each(search_event("/decs/search/en/"))
                .change(search_event("/decs/search/en/"));
        });
        // management_form.prefix
    </script>

    <h2>{{ title }}</h2>

    <form action="./" method="POST">
        {% for form in forms %}
        <fieldset>
            <legend>{% firstof form.title form.form.title %}</legend>
            <table>
                {{ form.as_table }}
            </table>
        </fieldset>
        {% endfor %}

        {% for formset in formsets %}
            {{ formset.management_form }}
            <fieldset>
            <legend>{{ formset.form.title }}</legend>


            <div class="{{formset.management_form.prefix}}">
            {% for form in formset.forms %}
                <table>
                    {{ form.as_table }}
                </table>
            {% endfor %}
    </div>
            <div style="text-align: center">
              <input onclick="cloneMore('div.{{formset.management_form.prefix}} table:last','{{formset.management_form.prefix}}')" type="button" value="add more"/>
</div>
            </fieldset>
        {% endfor %}

        <br/>

        <input name="submit_go" type="submit" value="{% trans "Save and continue later" %}"/>

        {% if next_form_title %}
        <input name="submit_next" type="submit" value="{% trans "Save and go to" %} '{{next_form_title}}'"/>
        {% endif %}
    </form>

{% endblock %}
